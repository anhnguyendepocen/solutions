---
title: 'ARM: Chapter 4'
output: html_document
---

### Question 1

#### (a)
The factors are $e^{-0.25}$ and $e^{0.25}$.

#### (b)
Import the height data used in Chapter 4, simulate weights, and plot:
```{r q1b, warning = F}
set.seed(1)

dat <- read_stata(
  'http://stat.columbia.edu/~gelman/arm/examples/earnings/heights.dta'
  )

dat$weight <- exp(-3.5 + 2 * log(dat$height) + rnorm(nrow(dat), 0, 0.25))

p <- ggplot(dat) +
  geom_point(aes(log(height), log(weight))) +
  geom_abline(aes(intercept = -3.5, slope = 2), col = 'red')
p
```

### Question 2

#### (a)
Remove missing values from the data:
```{r q2a}
# dat <- na.omit(dat)
```

#### (b)
Center height:
```{r q2b}
dat$height_c <- dat$height - mean(dat$height, na.rm = T)

reg <- lm(earn ~ height_c, data = dat) ; summary(reg)
```
So person of average height earns \$`r format(reg$coefficients[1], nsmall = 2, big.mark = ',')` on average.

#### (c)
Skip

### Question 3

Create similar dataset and models:
```{r q3}

# age (the original paper indicates the survey was conducted in 1990)
dat$age <- 90 - dat$yearbn
dat$age[dat$age <= 0] <- 1990 - (1800 + dat$yearbn[dat$age <= 0])

# age bins
dat <- dat %>%
  mutate(
    age_10  = age / 10,
    age_bin = NA,
    age_bin = replace(age_bin, age <= 29, 'age18_29'),
    age_bin = replace(age_bin, age >= 30 & age <= 44, 'age30_44'),
    age_bin = replace(age_bin, age >= 45 & age <= 64, 'age45_64'),
    age_bin = replace(age_bin, age >= 65, 'age65_up')
  )

# models
reg1 <- lm(weight ~ age_10, data = dat)
reg2 <- lm(weight ~ age_10 + I(age_10 ^ 2), data = dat)
reg3 <- lm(weight ~ factor(age_bin), data = dat)
```

#### (a) to (b)
```{r q3a, warning = F}

reg2_fun <- function(x) (-0.0157) / 100 * x ^ 2 + (-2.13) / 10 * x + 148

p <- ggplot(dat) +
  geom_point(aes(age, weight)) +
  geom_abline(
    aes(intercept = reg1$coefficients[1], slope = reg1$coefficients[2] / 10),
    col = 'red'
  ) +
  stat_function(fun = reg2_fun, colour = 'blue')
p
```

#### (c)
```{r q3c, warning = F}
p <- ggplot(dat) + 
  geom_point(data = select(dat, age, weight), aes(age, weight), colour = 'grey') +
  geom_point(aes(age, weight, colour = age_bin)) +
  scale_colour_manual(values = c("yellow", "green", "blue", "red")) +
  geom_hline(
    aes(yintercept = reg3$coefficients[1]),
    col = 'yellow',
    data = filter(dat, age_bin == 'age18_29')
  ) +
  geom_hline(
    aes(yintercept = reg3$coefficients[1] + reg3$coefficients[2]),
    col = 'green',
    data = filter(dat, age_bin == 'age30_44')
  ) +
  geom_hline(
    aes(yintercept = reg3$coefficients[1] + reg3$coefficients[3]),
    col = 'blue',
    data = filter(dat, age_bin == 'age45_64')
  ) +
  geom_hline(
    aes(yintercept = reg3$coefficients[1] + reg3$coefficients[4]),
    col = 'red',
    data = filter(dat, age_bin == 'age65_up')
  ) +
  facet_grid(~age_bin) +
  theme(legend.position = 'none')
p
```

### Question 4
Import the data:
```{r q4}
dat <- read_stata(
  'http://stat.columbia.edu/~gelman/arm/examples/pollution/pollution.dta'
  )
```

#### (a)
```{r q4a}
p1 <- ggplot(dat) +
  geom_point(aes(nox, mort))
p1

reg <- lm(mort ~ nox, data = dat) ; summary(reg)

dat <- dat %>%
  mutate(
    pred = predict(reg, data = dat),
    resid = mort - pred
  )

p2 <- ggplot(dat) +
  geom_point(aes(pred, resid))
p2
```

Linearity seems like a stretch here.  The outlier where nox is 319 results in a poor fit.  The residual plot confirms this approach is problematic.

#### (b)
Let's try using the log of nox:
```{r q4b}
p1 <- ggplot(dat) +
  geom_point(aes(log(nox), mort))
p1

reg <- lm(mort ~ log(nox), dat = dat) ; summary(reg)

dat <- dat %>%
  mutate(
    pred = predict(reg, data = dat),
    resid = mort - pred
  )

p2 <- ggplot(dat) +
  geom_point(aes(pred, resid))
p2

```

This works better.

#### (c)
A one percent increase in nox is associated with an increase of mortality of `r format(reg$coefficients[2], nsmall = 1)`.

#### (d)
```{r q4d}
dat_long <- gather(dat, poll, value, hc:so2)

p1 <- ggplot(dat_long) +
  geom_point(aes(value, mort)) +
  facet_grid(~poll)
p1

reg <- lm(mort ~ log(hc) + log(nox) + log(so2), data = dat) ; summary(reg)

p2 <- ggplot(dat_long) +
  geom_point(aes(log(value), mort)) +
  facet_grid(~poll) +
  geom_abline(
    aes(
      intercept = reg$coefficients[1] + log(mean(dat$nox) + log(mean(dat$so2))),
      slope = reg$coefficients[2]
    ),
    col = 'red',
    data = filter(dat_long, poll == 'hc')
  ) +
  geom_abline(
    aes(
      intercept = reg$coefficients[1] + log(mean(dat$hc) + log(mean(dat$so2))),
      slope = reg$coefficients[3]
    ),
    col = 'red',
    data = filter(dat_long, poll == 'nox')
  ) +
  geom_abline(
    aes(
      intercept = reg$coefficients[1] + log(mean(dat$hc) + log(mean(dat$nox))),
      slope = reg$coefficients[4]
    ),
    col = 'red',
    data = filter(dat_long, poll == 'so2')
  )
p2
```

Given a single pollutant with the levels of the other two fixed (perhaps at their mean values), the coefficients correspond to the change in mortality for a one percent change in the given pollutant.

#### (e)
```{r q4e}
reg <- lm(mort ~ log(hc) + log(nox) + log(so2), data = dat[1:30, ]) ; summary(reg)

dat <- dat %>%
  mutate(
    pred = predict(reg, newdata = dat),
    resid = mort - pred,
    code = c(rep('train', 30), rep('test', 30))
  )

p <- ggplot(dat) +
  geom_point(aes(pred, mort, colour = code)) +
  geom_abline(intercept = 0, slope = 1)
p
```

### Question 5

#### (a)
* This measure implicitly assumes that a dollar has the same impact on vote share across districts.  This is likely unrealistic; for example, advertising costs are likely to vary by district.
* This measure improves on the last but may be problematic in uncontested districts; it also may be skewed by noncompetitive districts.
* This measure improves on the last in terms of skewness but still may be problematic in uncontested districts.
* This measure seems the best as it is standardized, ranging between 0 and 1, and has a clear demarcation at one half where the candidates raise equal amounts. 

#### (b)
One possiblity would be to use the last measure $M_i = D_i / (D_i + R_i)$ but introduce nonlinearity via a $\beta$ regression.

### Question 6

This represents an elasticity.  Most likely the authors meant $\beta = -0.3$; economists often consider elasticities in absolute terms.  This means that a one percent increase in price is associated with a 0.3 decrease in quantity.  As expected, demand for cigarettes is inelastic.

### Question 7

Skip

### Question 8

Skip
